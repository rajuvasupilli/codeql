name: Customized CodeQL Analysis

on:
  workflow_dispatch:  # Manual trigger
  push:
    branches:
      - THEP-56

permissions:
  contents: read
  security-events: write

jobs:
  codeql:
    name: Run CodeQL Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 2  # Ensures we can compare against the previous commit

      - name: Get Changed Files
        id: changed-files
        run: |
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD -- '*.java' '*.js')
          if [[ -z "$CHANGED_FILES" ]]; then
            echo "No Java or JavaScript files changed. Skipping CodeQL."
            echo "skip_codeql=true" >> $GITHUB_ENV
          else
            echo "Changed files:"
            echo "$CHANGED_FILES"
            echo "$CHANGED_FILES" > changed_files.txt
            echo "skip_codeql=false" >> $GITHUB_ENV
          fi

      - name: Initialize CodeQL
        if: env.skip_codeql == 'false'
        uses: github/codeql-action/init@v3
        with:
          languages: java, javascript
          queries: security-and-quality
          build-mode: manual

      - name: Build Java Project
        if: env.skip_codeql == 'false'
        run: |
          mvn -f services/demo/pom.xml clean compile
          echo "Verifying compiled classes:"
          find services/demo -name "*.class" || echo "‚ùå No .class files found"

      - name: Perform CodeQL Analysis on Changed Files
        if: env.skip_codeql == 'false'
        run: |
          for file in $(cat changed_files.txt); do
            echo "Analyzing $file..."
            codeql database create --language=java --source-root="$(dirname "$file")" --database=codeql_db
          done

      - name: Run CodeQL Analysis
        if: env.skip_codeql == 'false'
        uses: github/codeql-action/analyze@v3
        with:
          category: custom
