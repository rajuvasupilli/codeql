name: Customized CodeQL Analysis

on:
  workflow_dispatch: # Manual trigger
  push:
    branches:
      - THEP-56

permissions:
  contents: read
  security-events: write

jobs:
  codeql:
    name: Run CodeQL Analysis
    permissions: write-all
    runs-on: [ubuntu-latest]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Get changed files
        id: changed-files
        run: |
          git fetch origin ${{ github.event.before }}
          CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} -- '*.java' '*.js')
          if [[ -z "$CHANGED_FILES" ]]; then
            echo "No Java or JavaScript files changed. Skipping CodeQL."
            echo "skip_codeql=true" >> $GITHUB_ENV
          else
            echo "Changed files:"
            echo "$CHANGED_FILES"
            echo "$CHANGED_FILES" > changed_files.txt
            echo "skip_codeql=false" >> $GITHUB_ENV
          fi

      - name: Install Node.js
        if: env.skip_codeql == 'false'
        run: |
          curl -sL https://deb.nodesource.com/setup_20.x | sudo -E bash -
          sudo apt-get install -y nodejs
          node -v

      - name: Build project
        if: env.skip_codeql == 'false'
        run: |
          mvn -f services/demo/pom.xml clean compile
          echo "Verifying compiled classes:"
          find services/demo -name "*.class" || echo "❌ No .class files found"

      - name: Initialize CodeQL
        if: env.skip_codeql == 'false'
        uses: github/codeql-action/init@v3
        with:
          languages: java, javascript
          queries: ./codeql-queries/
          build-mode: manual

      - name: Manual build for CodeQL
        if: env.skip_codeql == 'false'
        run: mvn -f services/demo/pom.xml clean compile

      - name: Perform CodeQL Analysis
        if: env.skip_codeql == 'false'
        uses: github/codeql-action/analyze@v3
        with:
          category: custom

      - name: Locate and Parse SARIF results
        if: env.skip_codeql == 'false'
        run: |
          echo "Searching for SARIF files..."
          sarif_files=$(find /home/runner/_work/ep-sred/results -iname '*.sarif')
          if [[ -z "$sarif_files" ]]; then
            echo "❌ No SARIF files found. CodeQL analysis may have failed."
            exit 1
          fi
          echo "SARIF_FILES: $sarif_files"
          
          for file in $sarif_files; do
            echo "Processing SARIF file: $file"
            jq -r '.runs[].results[] | "\(.level | ascii_upcase): \(.message.text) [File: \(.locations[0].physicalLocation.artifactLocation.uri)]"' "$file" || echo "✅ No issues found!"
          done
        shell: bash
